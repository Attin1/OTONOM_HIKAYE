<!DOCTYPE html>
<html lang="tr">
<head>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/plugins/split_text_to_size.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Otonom Hikaye Motoru v7</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700&family=Source+Code+Pro&display=swap');

        :root {
            --bg: #050505;  
            --panel: #111;
            --text: #eee;
            --accent: #00e5ff;
            --border: #333;
            --success: #00ff9d;
            --danger: #ff3860;
            --warn: #ffdd57;
            --sky-bg: #111;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Exo 2', sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            transition: background 2s ease;
        }

        /* Giriş Ekranı */
        #login-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 5, 5, 0.98);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 99;
        }

        .login-box {
            background: var(--panel);
            padding: 40px;
            border: 1px solid var(--accent);
            border-radius: 8px;
            width: 400px;
            text-align: center;
            box-shadow: 0 0 30px rgba(0, 229, 255, 0.15);
        }

        .login-box h2 {
            color: var(--accent);
            margin-top: 0;
            margin-bottom: 20px;
        }

        input[type="password"] {
            width: 90%;
            padding: 12px;
            margin: 15px 0;
            background: #000;
            color: #fff;
            border: 1px solid #444;
            font-family: 'Source Code Pro', monospace;
            text-align: center;
            border-radius: 4px;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 20px;
        }

        .btn {
            background: var(--accent);
            color: #000;
            padding: 12px 30px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-radius: 4px;
            transition: 0.3s;
        }
        .btn:hover { box-shadow: 0 0 15px var(--accent); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Oyun Arayüzü */
        .container {
            width: 95%;
            max-width: 1400px;
            height: 95vh;
            display: grid;
            grid-template-columns: 3fr 1fr;
            gap: 15px;
        }

        .panel {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Sol Panel: Hikaye */
        #story-log {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            font-size: 1.1rem;
            line-height: 1.7;
            scroll-behavior: smooth;
        }

        .ai-msg { 
            margin-bottom: 30px; 
            animation: fadeIn 0.5s ease; 
            border-left: 3px solid var(--accent); 
            padding-left: 15px; 
        }

        .user-choice-log { 
            color: #666; 
            font-size: 0.9rem; 
            margin-bottom: 20px; 
            font-style: italic; 
            border-left: 3px solid #333; 
            padding-left: 15px; 
        }

        #controls {
            padding: 20px;
            border-top: 1px solid var(--border);
            background: #0a0a0a;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .choice-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #444;
            color: #eee;
            padding: 8px 12px;
            text-align: left;
            cursor: pointer;
            font-family: 'Source Code Pro', monospace;
            font-size: 0.85rem;
            line-height: 1.3; 
            transition: 0.2s;
            border-radius: 4px;
        }
        .choice-btn:hover { 
            border-color: var(--accent); 
            color: var(--accent); 
            background: rgba(0, 229, 255, 0.05); 
        }

        .end-btn {
            margin-top: 10px;
            background: transparent;
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 10px;
            cursor: pointer;
            font-family: 'Source Code Pro', monospace;
            text-align: center;
            font-size: 0.8rem;
        }
        .end-btn:hover { background: var(--danger); color: #fff; }

        /* Sağ Panel: Analiz */
        .sidebar { 
            padding: 20px; 
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
        }
        
        .metric-box h3 {
            margin: 0 0 10px 0;
            font-size: 0.8rem;
            color: #888;
            text-transform: uppercase;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }

        /* Duygu Barı */
        .bar-container {
            width: 100%; 
            height: 10px; 
            background: #222; 
            border-radius: 5px; 
            overflow: hidden; 
            position: relative;
        }

        .bar-marker {
            position: absolute; 
            top: 0; 
            bottom: 0; 
            width: 4px; 
            background: #fff;
            box-shadow: 0 0 5px #000; 
            transition: left 1s ease-in-out;
        }

        /* Atmosfer Barları */
        .emotion-item {
            margin-bottom: 12px;
        }

        .emotion-label {
            font-size: 0.7rem;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
        }

        .emotion-value {
            color: var(--accent);
            font-weight: bold;
        }

        .bar-bg {
            width: 100%;
            height: 8px;
            background: #222;
            border-radius: 4px;
            overflow: hidden;
        }

        .emotion-bar {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 4px;
        }

        #sentiment-label { 
            font-size: 1.5rem; 
            color: var(--success); 
            font-weight: bold; 
            margin-top: 5px; 
        }

        #model-info { 
            font-size: 0.7rem; 
            color: #555; 
            margin-top: auto; 
            text-align: center; 
            padding-top: 20px;
        }

        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        .blink { animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        /* Duygu sıralama animasyonu */
        #atmosphere-bars {
            position: relative;
        }

        .emotion-item {
            transition: transform 0.5s ease, opacity 0.3s ease;
            will-change: transform;
        }


    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2>HİKAYE MOTORU v7</h2>
            <input type="password" id="api-key-input" placeholder="Google API Key (AIzaSy...)">
            
            <div class="checkbox-container">
                <input type="checkbox" id="save-key-check">
                <label for="save-key-check">Anahtarı bu tarayıcıya kaydet</label>
            </div>

            <button class="btn" onclick="initSystem()">BAĞLAN</button>
            <div id="login-msg" style="margin-top:15px; font-size:0.8rem; height:20px;"></div>
        </div>
    </div>

    <div class="container" id="game-interface" style="display:none;">
        
        <div class="panel">
            <div id="story-log"></div>
            <div id="controls"></div>
        </div>

        <div class="panel sidebar">
            
            
            <div class="metric-box">
                <h3>ANLIK HİKAYE ATMOSFERİ</h3>
                <div id="sentiment-label"
                    style="
                        font-size:1.6rem;
                        font-weight:700;
                        text-align:center;
                        margin-top:10px;
                        letter-spacing:1px;
                    ">
                    NÖTR
                </div>
            </div>
            

            <div class="metric-box">
                <h3>Duygu Analizi</h3>
                <div id="atmosphere-bars"></div>
            </div>

            <div class="metric-box">
                <h3>Sistem Durumu</h3>
                <div id="status-text" style="color:#888;">BEKLİYOR</div>
            </div>

            <div id="model-info">Model: <span id="model-name">...</span></div>
        </div>

    </div>

    <script>
        let API_KEY = "";
        let ACTIVE_MODEL = "";
        let storyHistory = [];
        let emotionData = {};
        let isFirstScene = true;
        let interactionLog = [];

        const EMOTIONS = {
            "melankoli": { color: "#f1c40f", theme_warm: "#f1c40f", theme_cold: "#2980b9", theme_sky: "#7f8c8d" },
            "saldırganlık": { color: "#e74c3c", theme_warm: "#e74c3c", theme_cold: "#000000", theme_sky: "#c0392b" },
            "rasyonellik": { color: "#ffffff", theme_warm: "#ffffff", theme_cold: "#2c3e50", theme_sky: "#3498db" },
            "paranoya": { color: "#9b59b6", theme_warm: "#9b59b6", theme_cold: "#1b2631", theme_sky: "#8e44ad" },
            "korku": { color: "#8e44ad", theme_warm: "#8e44ad", theme_cold: "#000000", theme_sky: "#2c3e50" },
            "cesaret": { color: "#c0392b", theme_warm: "#c0392b", theme_cold: "#2c3e50", theme_sky: "#2980b9" },
            "merak": { color: "#e67e22", theme_warm: "#e67e22", theme_cold: "#f1c40f", theme_sky: "#1abc9c" },
            "çaresizlik": { color: "#7f8c8d", theme_warm: "#95a5a6", theme_cold: "#2c3e50", theme_sky: "#34495e" },
            "huzur": { color: "#1abc9c", theme_warm: "#a3e4d7", theme_cold: "#2e4053", theme_sky: "#85c1e9" },
            "endişe": { color: "#f39c12", theme_warm: "#f5b041", theme_cold: "#566573", theme_sky: "#7d6608" },
            "umut": { color: "#2ecc71", theme_warm: "#58d68d", theme_cold: "#1e8449", theme_sky: "#27ae60" },  
            "romantizm": { color: "#ff69b4", theme_warm: "#ff69b4", theme_cold: "#2c3e50", theme_sky: "#e84393" },
            "öfke": { color: "#c0392b", theme_warm: "#e74c3c", theme_cold: "#2c3e50", theme_sky: "#922b21" },
            "suçluluk": { color: "#95a5a6", theme_warm: "#bdc3c7", theme_cold: "#2c3e50", theme_sky: "#7f8c8d" },
            "yalnızlık": { color: "#34495e", theme_warm: "#5d6d7e", theme_cold: "#1b2631", theme_sky: "#2c3e50" },
            "kararlılık": { color: "#1f618d", theme_warm: "#2980b9", theme_cold: "#154360", theme_sky: "#1abc9c" },
            "şaşkınlık": { color: "#f4d03f", theme_warm: "#f7dc6f", theme_cold: "#7d6608", theme_sky: "#f39c12" },
            "neşe": { color: "#f1c40f", theme_warm: "#f9e79f", theme_cold: "#7d6608", theme_sky: "#f7dc6f" },
            "umutsuzluk": { color: "#566573", theme_warm: "#5d6d7e", theme_cold: "#212f3c", theme_sky: "#2c3e50" },
            "tutku": { color: "#e84393", theme_warm: "#ff6fae", theme_cold: "#2c3e50", theme_sky: "#c0392b" }
        };

        // --- BAŞLANGIÇ ---
        window.onload = () => {
            const savedKey = localStorage.getItem("gemini_api_key_v7");
            if (savedKey) {
                document.getElementById('api-key-input').value = savedKey;
                document.getElementById('save-key-check').checked = true;
            }
            setupEmotionBars();
        };

        function setupEmotionBars() {
            const container = document.getElementById('atmosphere-bars');
            let html = '';
            
            Object.keys(EMOTIONS).forEach(key => {
                emotionData[key] = 0;
                html += `
                    <div class="emotion-item" style="display:none;">
                        <div class="emotion-label">
                            <span>${key}</span>
                            <span class="emotion-value" id="val-${key}">0%</span>
                        </div>
                        <div class="bar-bg">
                            <div id="bar-${key}" class="emotion-bar" style="width:0%; background:${EMOTIONS[key].color};"></div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        async function initSystem() {
            const keyInput = document.getElementById('api-key-input');
            const saveCheck = document.getElementById('save-key-check');
            const msgDiv = document.getElementById('login-msg');
            const btn = document.querySelector('.btn');

            API_KEY = keyInput.value.trim();
            if (!API_KEY) {
                msgDiv.innerText = "Lütfen API anahtarı girin!";
                msgDiv.style.color = "var(--danger)";
                return;
            }

            if (saveCheck.checked) {
                localStorage.setItem("gemini_api_key_v7", API_KEY);
            } else {
                localStorage.removeItem("gemini_api_key_v7");
            }

            msgDiv.innerHTML = "<span class='blink'>Model aranıyor...</span>";
            btn.disabled = true;

            try {
                const listUrl = `https://generativelanguage.googleapis.com/v1beta/models?key=${API_KEY}`;
                const response = await fetch(listUrl);
                const data = await response.json();

                if (!response.ok) throw new Error("API Key geçersiz veya bağlantı yok.");

                if (!data.models || !Array.isArray(data.models)) {
                    throw new Error("Model listesi alınamadı");
                }

                const models = data.models.filter(m =>
                    m.supportedGenerationMethods &&
                    m.supportedGenerationMethods.includes("generateContent")
                );
                
                let selected = models.find(m => m.name.includes("gemini-1.5-flash"));
                if (!selected) selected = models.find(m => m.name.includes("gemini-1.0-pro"));
                if (!selected) selected = models[0];

                ACTIVE_MODEL = selected.name.replace("models/", "");

                msgDiv.innerText = "Bağlandı!";
                msgDiv.style.color = "var(--success)";
                
                setTimeout(() => {
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('game-interface').style.display = 'grid';
                    document.getElementById('model-name').innerText = ACTIVE_MODEL;
                    startGame();
                }, 800);

            } catch (err) {
                msgDiv.innerText = "Hata: " + err.message;
                msgDiv.style.color = "var(--danger)";
                btn.disabled = false;
            }
        }

        // --- HİKAYE MOTORU ---
        let isGenerating = false;

        async function generateContent(userPrompt, isFinal = false, choiceData = null) {
            if (isGenerating) {
                console.warn("Zaten bir istek devam ediyor!");
                return;
            }
            
            isGenerating = true;
            
            const controls = document.getElementById('controls');
            const statusText = document.getElementById('status-text');
            
            controls.innerHTML = `<div style="text-align:center; color:#666; padding:20px;" class="blink">> ${isFinal ? "FİNAL YAZILIYOR..." : "YENİ SENARYO HESAPLANIYOR..."}</div>`;
            statusText.innerText = "YAPAY ZEKA DÜŞÜNÜYOR...";
            statusText.style.color = "var(--accent)";

            if (storyHistory.length === 0) {
                let systemInstruction = `
            Sen bir interaktif hikâye motorusun.
            Yanıtın SADECE geçerli bir JSON olmalı. Açıklama, markdown, metin yazma.

            FORMAT:
            {
            "text": "Hikâye sahnesi",
            "choices": [
                {
                "text": "Seçenek metni",
                "emotion": "romantizm | merak | korku | rasyonellik | cesaret | paranoya | melankoli | saldırganlık | çaresizlik | huzur | endişe | umut | romantizm | öfke | suçluluk | yalnızlık | kararlılık | şaşkınlık | neşe | umutsuzluk | tutku"
                "emotions": {
                    "merak": 0.34,
                    "korku": 0.33,
                    "cesaret": 0.33
                }
                }
            ],
            "sentiment": {
                "primary": "merak",
                "intensity": 70,
                "score": 50,
                "label": "Gergin"
            }
            }

            KURALLAR:
            - JSON dışında HİÇBİR şey yazma.
            - choices bir DİZİ olmak zorunda.
            - İlk sahnede choices ASLA boş olamaz.
            - En az 2 seçim üret.
            - Her seçim FARKLI baskın duygu taşımalı.
            - emotions içindeki değerlerin toplamı = 1.0 olmalı.
            - emotions içinde en az 3 duygu olmalı.
            - Eski seçimlerde kullanılmamış duyguları tercih et.
            `;

                if (isFinal) {
                    systemInstruction += `
            BU SAHNE FİNALDİR.
            choices: [] olmak ZORUNDA.
            JSON dışında HİÇBİR ŞEY yazma.
            `;
                }

                storyHistory.push({
                    role: "user",
                    parts: [{ text: systemInstruction }]
                });
            }

            // --- EMOTION STATE EKLE (modelin hikayeyi duygulara göre sürdürmesi için) ---
    const emotionState = getEmotionStateForModel();
    if (emotionState) {
        storyHistory.push({
            role: "user",
            parts: [{ text: `EMOTION_STATE: ${JSON.stringify(emotionState)}` }]
        });
    }

    storyHistory.push({ role: "user", parts: [{ text: userPrompt }] });

    const url = `https://generativelanguage.googleapis.com/v1beta/models/${ACTIVE_MODEL}:generateContent?key=${API_KEY}`;

    const contents = [...storyHistory];

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: contents,
                generationConfig: {
                    responseMimeType: "application/json",
                    temperature: 0.9
                    
                }
            })

        });

        const data = await response.json();

        if (!response.ok) {
            console.error("API Hatası:", data);
            throw new Error(data.error?.message || "API erişim hatası");
        }

        if (!data.candidates || !data.candidates[0]) {
            console.error("Boş cevap:", data);
            throw new Error("Model yanıt vermedi (boş candidates)");
        }

        let rawText = data.candidates[0].content.parts
            .map(p => p.text || "")
            .join("")
            .trim();
        rawText = rawText.replace(/```json/g, "").replace(/```/g, "").trim();
        
        let storyData;
        try {
            storyData = JSON.parse(rawText);
        } catch {
            try {
                const start = rawText.indexOf("{");
                const end = rawText.lastIndexOf("}");
                if (start !== -1 && end !== -1) {
                    storyData = JSON.parse(rawText.slice(start, end + 1));
                } else {
                    throw new Error();
                }
            } catch {
                console.error("JSON Parse Edilemedi:", rawText);
                throw new Error("Model JSON formatında yanıt vermedi");
            }
        }

        storyHistory.push({ role: "model", parts: [{ text: storyData.text }] });
        if(!storyData.sentiment) {
            storyData.sentiment = {
                primary: "rasyonellik",
                intensity: 50,
                score: 50,
                label: "Nötr"
            };
        }

        renderScene(storyData);
        
        statusText.innerText = "BEKLİYOR";
        statusText.style.color = "#888";

    } catch (err) {
        console.error("Hata:", err);
        controls.innerHTML = `<div style="color:var(--danger)">Hata: ${err.message}<br><button class="end-btn" onclick="startGame()">Yeniden Başla</button></div>`;
        statusText.innerText = "HATA";
        statusText.style.color = "var(--danger)";
    } finally {
        isGenerating = false;
    }
}

function renderScene(data) {
    if (!data || typeof data !== 'object') {
        console.error("Invalid scene data:", data);
        return;
    }

    // Validate choices
    if (!Array.isArray(data.choices)) data.choices = [];
    
    data.choices = data.choices.filter(c =>
        c && typeof c === 'object' &&
        typeof c.text === "string" &&
        c.text.trim().length > 0 &&
        typeof c.emotions === "object" &&
        c.emotions !== null
    ).slice(0, 5); // Maximum 5 choices

    data.choices = data.choices.map(c => ({
        ...c,
        emotion: c.emotion || "merak",
        emotions: c.emotions && typeof c.emotions === 'object' ? normalizeEmotions(c.emotions) : { "merak": 1 }
    }));

    const log = document.getElementById('story-log');
    const controls = document.getElementById('controls');
    
    if (!log || !controls) return;

    const p = document.createElement('div');
    p.className = 'ai-msg';
    p.innerHTML = marked.parse(data.text || "");
    log.appendChild(p);
    log.scrollTop = log.scrollHeight;

    if (data.sentiment && typeof data.sentiment === 'object') {
        updateSentiment(data.sentiment);
    }

    controls.innerHTML = "";

    // If no choices and not final scene, request regeneration
    if (data.choices.length === 0 && isFirstScene) {
        console.warn("No choices generated, requesting retry...");
        setTimeout(() => {
            generateContent("Eksik seçenekler. Lütfen 2-3 seçeneği JSON formatında ver.", false);
        }, 1000);
        return;
    }

    // ✅ FIX: Eğer choices boş ise HIKAYE BİTTİ demektir
    if (data.choices.length === 0) {
        // Story ended
        controls.innerHTML = `
            <button class="btn" onclick="downloadStoryPDF()">PDF OLARAK İNDİR</button>
            <br><br>
            <button class="btn" onclick="location.reload()">YENİ HİKAYE</button>
        `;
        return;
    }

    // Choices varsa göster
    if (data.choices.length > 0) {
        data.choices.forEach(choice => {
            const btn = document.createElement('button');
            btn.className = 'choice-btn';
            btn.innerText = choice.text;
            btn.onclick = () => handleChoice(choice, log);
            controls.appendChild(btn);
        });

        // Add free text input
        const inputWrapper = document.createElement('div');
        inputWrapper.style.marginTop = "3px";
        inputWrapper.innerHTML = `
            <div style="display:flex; gap:5px; align-items:flex-start;">
                <textarea id="free-text-input"
                    placeholder="Seçeneklerden birini seçebilir veya kendi metnini yaz..."
                    style="
                        width:100%;
                        min-height:50px;
                        background:#000;
                        color:#fff;
                        border:1px solid #444;
                        padding:10px;
                        font-family:'Source Code Pro', monospace;
                        resize:vertical;
                    "></textarea>
                <button id="free-text-send"
                    style="
                        height:50px;
                        padding:0 12px;
                        font-size:0.7rem;
                        white-space:nowrap;
                        background:rgba(255,255,255,0.05);
                        border:1px solid #444;
                        color:#aaa;
                        cursor:pointer;
                        border-radius:4px;
                    ">
                    ▶ Devam
                </button>
            </div>
        `;

        const sendBtn = inputWrapper.querySelector("#free-text-send");
        sendBtn.onclick = () => handleFreeText(log);
        controls.appendChild(inputWrapper);

        const endBtn = document.createElement('button');
        endBtn.className = 'end-btn';
        endBtn.innerText = "HİKAYEYİ SONLANDIR";
        endBtn.onclick = () => {
            if (confirm("Hikayeyi bitirmek istiyor musun?")) {
                generateContent(
                    "Kullanıcı hikayeyi bitirmek istiyor. Mevcut duygusal atmosfere uygun bir final yaz. choices: [] olmalı.",
                    true
                );
            }
        };
        controls.appendChild(endBtn);
    }

    isFirstScene = false;
}

        function updateSentiment(sentiment) {
            const label = document.getElementById('sentiment-label');
            
            if (!label) return;
            
            const score = sentiment.score || 50;
            
            label.innerText = (sentiment.label || "NÖTR").toUpperCase();
            
            if (score < 30) label.style.color = "var(--danger)";
            else if (score > 70) label.style.color = "var(--success)";
            else label.style.color = "var(--warn)";
        }

        function updateEmotions(primary, intensity) {
            const MAX_EMOTION = 100; // her duygu için maksimum %25
    if (!primary || typeof intensity !== "number") return;

    // intensity parametresi artık doğrudan eklenecek (çağıran yerlerde küçültüldü)
    if (emotionData[primary] !== undefined) {
        emotionData[primary] = Math.min(MAX_EMOTION, emotionData[primary] + intensity);
    }

    // Tüm barları güncelle
    Object.keys(emotionData).forEach(key => {
        const bar = document.getElementById(`bar-${key}`);
        const val = document.getElementById(`val-${key}`);
        const item = bar?.closest('.emotion-item');
        if (bar && val && item) {
            const percent = Math.round(emotionData[key]);
            if (percent <= 0) {
                item.style.display = "none";
            } else {
                if (item.style.display === "none") {
                    item.style.display = "block";
                    item.style.animation = "fadeIn 0.4s ease";
                }
                bar.style.width = `${percent}%`;
                val.innerText = `${percent}%`;
            }
        }
    });

    const dominant = getDominantEmotion();

    if (dominant && EMOTIONS[dominant]) {
        const theme = EMOTIONS[dominant];
        document.documentElement.style.setProperty('--accent', theme.theme_sky);
        document.body.style.backgroundColor = theme.color;
        const storyLog = document.getElementById('story-log');
        if (storyLog) {
            storyLog.style.borderTop = `5px solid ${theme.theme_cold}`;
            storyLog.style.boxShadow = `inset 0 20px 50px -20px ${theme.theme_cold}44`;
        }
    }

    // Sıralama animasyonu (aynı)
    const container = document.getElementById("atmosphere-bars");
    const items = Array.from(container.children).filter(item => item.style.display !== "none");
    const positions = new Map();
    items.forEach(item => positions.set(item, item.getBoundingClientRect().top));
    items.sort((a, b) => {
        const aKey = a.querySelector(".emotion-value")?.id?.replace("val-", "");
        const bKey = b.querySelector(".emotion-value")?.id?.replace("val-", "");
        return (emotionData[bKey] || 0) - (emotionData[aKey] || 0);
    });
    items.forEach(item => container.appendChild(item));
    items.forEach(item => {
        const oldTop = positions.get(item);
        const newTop = item.getBoundingClientRect().top;
        const delta = oldTop - newTop;
        item.style.transform = `translateY(${delta}px)`;
    });
    requestAnimationFrame(() => items.forEach(item => item.style.transform = ""));
        }

        
        function startGame() {
            isFirstScene = true;
            const lbl = document.getElementById('sentiment-label');

            if (lbl) lbl.innerText = "NÖTR";

            storyHistory = [];
            document.getElementById('story-log').innerHTML = "";
            
            // Duyguları sıfırla
            Object.keys(emotionData).forEach(key => {emotionData[key] = 0;});
            document.documentElement.style.setProperty('--accent', '#00e5ff');
            document.body.style.backgroundColor = '#050505';
            
            const themes = [
                "Siberpunk bir şehirde, yağmurlu bir gecede işlenen gizemli bir suç.",
                "Terk edilmiş bir su altı araştırma tesisinde geçen klostrofobik bir gerilim.",
                "Orta Çağ fantezisi ama büyü teknolojinin yerini almış.",
                "Issız bir çöl gezegeninde hayatta kalmaya çalışan bir kaşif.",
                "1920'lerin İstanbul'unda geçen, doğaüstü olaylar içeren bir dedektiflik hikayesi.",
                "Yapay zekaların yönettiği bir ütopyada sistem hatası bulan bir yazılımcı.",
                "Kutuplarda mahsur kalan bir ekip ve aralarında insan olmayan bir şey.",
                "Rüyaların kaydedilebildiği bir gelecekte, başkasının kabusunda sıkışıp kalmak.",
                "Telepatik iletişimin mümkün olduğu bir evrende geçen sır ghikayesi.",
                "Tolkienin yarattığı Orta Dünyada geçen karakterin insan, büyücü, elf, org veya cüce olduğu bir macera."
            ];

            const randomTheme = themes[Math.floor(Math.random() * themes.length)];

            const komut = `Şu konsepti temel alarak bir hikaye başlat: "${randomTheme}". 
            
            Lütfen şu klişeleri KULLANMA: 
            - "Gözlerini açtı ve nerede olduğunu hatırlamıyordu."
            - "Soğuk metal zeminde uyandı."
            
            Bunun yerine doğrudan aksiyonun veya gizemin ortasından başla. Giriş sahnesini yaz ve 2-3 seçenek sun.`;
            
            generateContent(komut);
        }

        function getDominantEmotion() {
            let maxEmotion = null;
            let maxValue = -Infinity;

            Object.entries(emotionData).forEach(([key, value]) => {
                if (value > maxValue) {
                    maxValue = value;
                    maxEmotion = key;
                }
            });

            return maxEmotion;
        }

        async function downloadStoryPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF("p", "mm", "a4");               
            doc.setFontSize(10);
            doc.text("Font yükleniyor, lütfen bekleyiniz...", 15, 15);

            const getBase64FromUrl = async (url) => {
                const data = await fetch(url);
                const blob = await data.blob();
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(blob);
                    reader.onloadend = () => {
                        const base64data = reader.result;
                        resolve(base64data.split(',')[1]);
                    }
                });
            };

            try {
                const fontBase64 = await getBase64FromUrl("https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf");
                
                doc.addFileToVFS("Roboto-Regular.ttf", fontBase64);
                doc.addFont("Roboto-Regular.ttf", "Roboto", "normal");
                doc.setFont("Roboto");

                doc.deletePage(1);
                doc.addPage();
                
                const margin = 15;
                const pageHeight = 297;
                const pageWidth = 210;
                const contentWidth = pageWidth - (margin * 2); // 180mm (A4 genişliği - kenarlar)
                let y = margin;

                function checkPage(add = 6) {
                    if (y + add > pageHeight - margin) {
                        doc.addPage();
                        y = margin;
                    }
                }

                doc.setFontSize(14);
                doc.text("Otonom Hikaye Motoru – Hikaye Raporu", margin, y);
                y += 10;

                doc.setFontSize(10);
                doc.text(`Tarih: ${new Date().toLocaleString("tr-TR")}`, margin, y);
                y += 10;

                doc.setFontSize(11);
                doc.text("Hikaye Metni:", margin, y);
                y += 8;

                const nodes = document.querySelectorAll(".ai-msg, .user-choice-log");
                let storyText = "";

                nodes.forEach((el) => {
                    if (el.classList.contains("ai-msg")) {
                        storyText += `SAHNE:\n${el.innerText}\n\n`;
                    } else if (el.classList.contains("user-choice-log")) {
                        storyText += `KULLANICI:\n${el.innerText.replace("▸", "").trim()}\n\n`;
                    }
                    storyText += "---------------------------------------------\n\n";
                });

                const lines = doc.splitTextToSize(storyText, contentWidth);
                
                lines.forEach(line => {
                    checkPage(6);
                    doc.text(line, margin, y);
                    y += 6;
                });

                y += 10;
                checkPage();

                doc.setFontSize(12);
                doc.text("Duygu Analizi:", margin, y);
                y += 8;

                doc.setFontSize(10);
                if (typeof emotionData !== 'undefined') {
                    Object.keys(emotionData).forEach(key => {
                        checkPage(6);
                        doc.text(`${key.toLocaleUpperCase('tr-TR')}: %${Math.round(emotionData[key])}`, margin, y);
                        y += 6;
                    });
                }

                doc.save("hikaye_raporu.pdf");

            } catch (err) {
                console.error("PDF oluşturma hatası:", err);
                alert("PDF oluşturulurken font yükleme hatası oluştu. İnternet bağlantınızı kontrol edin.");
            }
        }

        function res(emo) {
            return {
                primary: emo,
                emotions: { [emo]: 1 },
                sentiment: {
                    score:
                        emo === "neşe" ? 75 :
                        emo === "huzur" ? 60 :
                        emo === "endişe" ? 45 :
                        emo === "öfke" ? 35 :
                        emo === "çaresizlik" ? 20 : 50,
                    label: emo
                }
            };
        }

        function analyzeEmotionFallback(text) {
            const t = text.toLowerCase().trim();
            
            // Duygu analizi kuralları
            const emotionMap = {
                "merak": ["neden", "nasıl", "ne", "nedir", "bilmek"],
                "korku": ["korkuyor", "ürküyor", "şey", "hız"],
                "cesaret": ["yapacağım", "başarırım", "güçlü", "girişim"],
                "neşe": ["harika", "güzel", "seviyorum", "mutlu"],
                "üzüntü": ["üzüldü", "kötü", "acı", "çaresiz"],
                "merak": ["sorular", "anlamak", "keşfet"],
                "öfke": ["sinirli", "kızgın", "öfkeliyim", "hata"],
                "huzur": ["rahat", "huzurlu", "sakin", "güvende"],
                "endişe": ["endişeliyim", "kaygılı", "stresli", "gergin"],
                "umut": ["umarım", "dilerim", "iyi olur", "pozitif"],
                "romantizm": ["aşk", "romantik", "sevgili", "kalp"],
                "suçluluk": ["suçlu", "pişman", "hata yaptım", "özür"],
                "yalnızlık": ["yalnız", "kimse yok", "terk edilmiş", "sadece"],
                "kararlılık": ["kararlıyım", "azimli", "hedef", "başaracağım"],
                "şaşkınlık": ["şaşkınım", "inanamıyorum", "beklenmedik", "şok"]

            };
            
            let detected = "merak";
            let score = 50;
            
            for (const [emotion, keywords] of Object.entries(emotionMap)) {
                if (keywords.some(kw => t.includes(kw))) {
                    detected = emotion;
                    score = 60;
                    break;
                }
            }
            
            return {
                primary: detected,
                emotions: { [detected]: 1 },
                sentiment: {
                    score: score,
                    label: detected
                }
            };
        }

        // 1. analyzeFreeTextEmotion - Basit ve güvenilir:

async function analyzeFreeTextEmotion(text) {
    const prompt = `Kullanıcı şu metni yazdı:
"${text}"

Bu metnin duygusal tonunu analiz et. JSON formatında cevap ver:
{
"emotions": {
    "merak": 0.4,
    "cesaret": 0.3,
    "umut": 0.3
},
"primary": "merak",
"sentiment": {
    "score": 60,
    "label": "Aktif"
}
}

Kurallar:
- Sadece JSON, herhangi bir açıklama yapma
- emotions değerleri toplamı 1.0 olmalı
- 2-3 duygu kullan
`;

    const url = `https://generativelanguage.googleapis.com/v1beta/models/${ACTIVE_MODEL}:generateContent?key=${API_KEY}`;

    try {
        const response = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                contents: [{
                    role: "user",
                    parts: [{ text: prompt }]
                }],
                generationConfig: {
                    temperature: 0.5,
                    responseMimeType: "application/json"
                }
            })
        });

        const data = await response.json();

        if (!response.ok) {
            console.warn("API hatası, fallback kullanılıyor");
            return analyzeEmotionFallback(text);
        }

        let raw = data.candidates[0].content.parts
            .map(p => p.text || "")
            .join("")
            .replace(/```json|```/g, "")
            .trim();

        let result = JSON.parse(raw);
        
        // Normalize
        const total = Object.values(result.emotions || {}).reduce((a, b) => a + b, 0);
        if (total > 0 && result.emotions) {
            Object.keys(result.emotions).forEach(key => {
                result.emotions[key] = result.emotions[key] / total;
            });
        }
        
        return result;

    } catch (err) {
        console.warn("JSON parse hatası, fallback kullanılıyor:", err);
        return analyzeEmotionFallback(text);
    }
}

// 2. handleFreeText - Basit, prompt kandırmıyor:

async function handleFreeText(log) {
    const textarea = document.getElementById("free-text-input");
    const text = textarea?.value.trim();
    if (!text) {
        alert("Lütfen bir metin girin!");
        return;
    }

    const userLog = document.createElement('div');
    userLog.className = 'user-choice-log';
    userLog.innerText = `▸ ${text}`;
    log.appendChild(userLog);
    log.scrollTop = log.scrollHeight;

    const controls = document.getElementById('controls');
    const statusText = document.getElementById('status-text');

    controls.innerHTML = `<div style="text-align:center; color:#666; padding:20px;" class="blink">> YENİ SENARYO HESAPLANIYOR...</div>`;
    statusText.innerText = "YAPAY ZEKA DÜŞÜNÜYOR...";
    statusText.style.color = "var(--accent)";

    try {
        const analysis = await analyzeFreeTextEmotion(text);
        if (!analysis || !analysis.emotions) throw new Error("Analiz başarısız");

        interactionLog.push({
            type: "free-text",
            text: text,
            analysis: analysis,
            dominantEmotion: analysis.primary,
            time: new Date().toISOString()
        });

        // DUYGULARI EKLE — kullanıcı girdisinin etkisini artırdım (ancak updateEmotions içindeki MAX_EMOTION ile sınırlı)
        Object.entries(analysis.emotions).forEach(([emo, val]) => {
            if (emotionData[emo] !== undefined) {
                updateEmotions(emo, Math.round(val * 60)); 
            }
        });

        updateSentiment(analysis.sentiment);

        const prompt = `Kullanıcı şunu yazdı: "${text}"\n\nHikayeyi bu girdiye uygun şekilde devam ettir. Seçenekleri JSON formatında ver.`;

        await generateContent(prompt, false);

        if (textarea) textarea.value = "";
    } catch (err) {
        console.error("Hata:", err);
        controls.innerHTML = "";
        statusText.innerText = "HATA";
        statusText.style.color = "var(--danger)";
    }
}

// 3. handleChoice - Aynı basit format:

async function handleChoice(choice, log) {
    const userLog = document.createElement('div');
    userLog.className = 'user-choice-log';
    userLog.innerText = `▸ ${choice.text}`;
    log.appendChild(userLog);
    log.scrollTop = log.scrollHeight;

    interactionLog.push({
        type: "choice",
        text: choice.text,
        emotions: choice.emotions,
        dominantEmotion: choice.emotion,
        time: new Date().toISOString()
    });

    // Seçenek duygularını uygun düzeye getir (daha etkili ama yine MAX_EMOTION ile sınırlandırılır)
    Object.entries(choice.emotions).forEach(([emo, weight]) => {
        if (emotionData[emo] !== undefined) {
            updateEmotions(emo, Math.round(weight * 60));
        }
    });

    const prompt = `Kullanıcı şunu seçti: "${choice.text}"\n\nHikayeyi devam ettir.`;
    await generateContent(prompt, false, choice);
}

// Yeni: model'e gönderilecek duygusal özet
function getEmotionStateForModel() {
    // emotionData içindeki mevcut yüzde değerlerini al ve model için normalize et (0..1)
    const entries = Object.entries(emotionData).filter(([, v]) => v > 0);
    if (entries.length === 0) return null;

    const total = entries.reduce((s, [, v]) => s + v, 0);
    const emotions = {};
    entries.forEach(([k, v]) => {
        emotions[k] = +(v / total).toFixed(3); // toplam 1 olacak şekilde
    });

    const dominant = getDominantEmotion() || Object.keys(emotions)[0];

    return {
        emotions,
        dominant,
        raw: Object.fromEntries(entries) // ham % değerler (0..25)
    };
}

// Yeni: emotions objesini normalize edip geçerli duygu anahtarlarına eşler
function normalizeEmotions(input) {
    if (!input || typeof input !== 'object') return { merak: 1 };

    const cleaned = {};
    Object.entries(input).forEach(([k, v]) => {
        if (!k) return;
        const key = k.toString().trim().toLowerCase();
        const val = Number(v) || 0;
        if (EMOTIONS[key] && val > 0) cleaned[key] = (cleaned[key] || 0) + val;
    });

    // Eğer model bilinmeyen anahtarlar döndürdüyse veya hiç duygu yoksa varsayılanla devam et
    if (Object.keys(cleaned).length === 0) {
        return { merak: 1 };
    }

    // En az 3 duygu olması isteniyorsa eksik olanları küçük değerlerle ekle
    const need = Math.max(0, 3 - Object.keys(cleaned).length);
    if (need > 0) {
        const available = Object.keys(EMOTIONS).filter(k => !cleaned[k]);
        for (let i = 0; i < need && available.length > 0; i++) {
            cleaned[available.shift()] = 0.01;
        }
    }

    // Normalize et (toplam = 1)
    let total = Object.values(cleaned).reduce((s, x) => s + x, 0);
    if (total === 0) {
        return { merak: 1 };
    }
    Object.keys(cleaned).forEach(k => cleaned[k] = +(cleaned[k] / total).toFixed(3));

    // Küçük yuvarlama farkını en büyük elemana ekle
    let sum = Object.values(cleaned).reduce((s, x) => s + x, 0);
    const diff = Math.round((1 - sum) * 1000) / 1000;
    if (Math.abs(diff) >= 0.001) {
        const maxKey = Object.keys(cleaned).reduce((a, b) => cleaned[a] >= cleaned[b] ? a : b);
        cleaned[maxKey] = +((cleaned[maxKey] + diff).toFixed(3));
    }

    return cleaned;
}
    </script>
</body>
</html>